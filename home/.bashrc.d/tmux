# General settings/aliases/etc.
if [[ -n $(command -pv tmux 2> /dev/null) ]]; then
  alias tmux="$(command -pv tmux) -2"

  # Bash completion
  function _tmux_complete_client() {
    local IFS=$'\n'
    local cur="${1}"
    COMPREPLY=( ${COMPREPLY[@]:-} $(compgen -W "$(tmux -q list-clients | cut -f 1 -d ':')" -- "${cur}") )
  }

  # Complete all sessions
  function _tmux_complete_session() {
    local IFS=$'\n'
    local cur="${1}"
    COMPREPLY=( ${COMPREPLY[@]:-} $(compgen -W "$(tmux -q list-sessions | cut -f 1 -d ':')" -- "${cur}") )
  }

  # Completes session first, then window.
  function _tmux_complete_window() {
    local IFS=$'\n'
    local cur="${1}"
    local session_name="$(echo "${cur}" | sed 's/\\//g' | cut -d ':' -f 1)"
    local sessions

    sessions="$(tmux -q list-sessions | sed -re 's/([^:]+:).*$/\1/')"
    if [[ -n "${session_name}" ]]; then
      sessions="${sessions}
      $(tmux -q list-windows -t "${session_name}" | sed -re 's/^([^:]+):.*$/'"${session_name}"':\1/')"
    fi
    cur="$(echo "${cur}" | sed -e 's/:/\\\\:/')"
    sessions="$(echo "${sessions}" | sed -e 's/:/\\\\:/')"
    COMPREPLY=( ${COMPREPLY[@]:-} $(compgen -W "${sessions}" -- "${cur}") )
  }

  function _tmux() {
    local cur prev
    local i cmd cmd_index option option_index
    local options=""

    COMPREPLY=()
    cur="$(_get_cword ":")"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

  	# Search for the command
  	for ((i=1; $i<=$COMP_CWORD; i++)); do
  		if [[ ${COMP_WORDS[i]} != -* ]]; then
  			cmd="${COMP_WORDS[i]}"
  			cmd_index=${i}
  			break
  		fi
  	done

  	# Search for the last option command
  	for ((i=1; $i<=$COMP_CWORD; i++)); do
  		if [[ ${COMP_WORDS[i]} == -* ]]; then
  			option="${COMP_WORDS[i]}"
  			option_index=${i}
  			if [[ ${COMP_WORDS[i]} == -- ]]; then
  			  break;
        fi
  		fi
  	done

  	if [[ $COMP_CWORD -le $cmd_index ]]; then
  	  # The user has not specified a command yet
      local aliases="attach detach has lsc lscm ls lockc locks new refresh \
        rename source start suspendc switchc"
      local all_commands="${aliases} $(tmux -q list-commands | cut -f 1 -d ' ')"
      COMPREPLY=( ${COMPREPLY[@]:-} $(compgen -W "${all_commands}" -- "${cur}") )
    else
      case "${cmd}" in
        ######################
        # CLIENTS AND SESSIONS
        ######################
        attach-session|attach|att)
          case "$prev" in
            -t) _tmux_complete_session "${cur}" ;;
            *) options="-r -t -d" ;;
          esac ;;
        detach-client|detach)
          case "$prev" in
            -t) _tmux_complete_client "${cur}" ;;
            *) options="-t" ;;
          esac ;;
        lock-client|lockc)
          case "$prev" in
            -t) _tmux_complete_client "${cur}" ;;
            *) options="-t" ;;
          esac ;;
        lock-session|locks)
          case "$prev" in
            -t) _tmux_complete_session "${cur}" ;;
            *) options="-t -d" ;;
          esac ;;
        new-sesison|new)
          case "$prev" in
            -t) _tmux_complete_session "${cur}" ;;
            -n|-d|-s) options="-d -n -s -t --" ;;
            *)
              if [[ ${COMP_WORDS[option_index]} == -- ]]; then
                _command_offset ${option_index}
              else
                options="-d -n -s -t --"
              fi
              ;;
          esac
          ;;
        refresh-client|refresh)
          case "$prev" in
            -t) _tmux_complete_client "${cur}" ;;
            *) options="-t" ;;
          esac ;;
        rename-session|rename)
          case "$prev" in
            -t) _tmux_complete_session "${cur}" ;;
            *) options="-t" ;;
          esac ;;
        source-file|source) _filedir ;;
        has-session|has|kill-session)
          case "$prev" in
            -t) _tmux_complete_session "${cur}" ;;
            *) options="-t" ;;
          esac ;;
        suspend-client|suspendc)
          case "$prev" in
            -t) _tmux_complete_client "${cur}" ;;
            *) options="-t" ;;
          esac ;;
        switch-client|switchc)
          case "$prev" in
            -c) _tmux_complete_client "${cur}" ;;
            -t) _tmux_complete_session "${cur}" ;;
            *) options="-l -n -p -c -t" ;;
          esac ;;

        ###################
        # WINDOWS AND PANES
        ###################

        # TODO(darke): Actually add the completion for these commands

        ##############
        # KEY BINDINGS
        ##############
        send-keys|send)
          case "$option" in
            -t) _tmux_complete_window "${cur}" ;;
            *) options="-t" ;;
          esac ;;
      esac
    fi
    if [[ -n "${options}" ]]; then
      COMPREPLY=( ${COMPREPLY[@]:-} $(compgen -W "${options}" -- "${cur}") )
    fi
  }
  complete -F _tmux tmux
fi
# vim: set ft=sh ts=2 sw=2 tw=0 :

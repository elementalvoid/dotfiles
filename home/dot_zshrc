# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Ensure path arrays do not contain duplicates.
typeset -gU cdpath fpath mailpath path

path=(
  .
  $HOME/bin
  $HOME/{.local,code/go}/bin
  $HOME/.local/share/{chezmoi,chezmoi-private}/bin
  /opt/homebrew/{bin,sbin}
  /usr/sbin
  $path
)

fpath=(
  ~/.zsh_completions
  $fpath
)

### Added by Zinit's installer
if [[ ! -f $HOME/.zinit/bin/zinit.zsh ]]; then
    print -P "%F{33}▓▒░ %F{220}Installing %F{33}DHARMA%F{220} Initiative Plugin Manager (%F{33}zdharma/zinit%F{220})…%f"
    command mkdir -p "$HOME/.zinit" && command chmod g-rwX "$HOME/.zinit"
    command git clone https://github.com/zdharma-continuum/zinit "$HOME/.zinit/bin" && \
        print -P "%F{33}▓▒░ %F{34}Installation successful.%f%b" || \
        print -P "%F{160}▓▒░ The clone has failed.%f%b"
fi

source "$HOME/.zinit/bin/zinit.zsh"
autoload -Uz _zinit
autoload bashcompinit && bashcompinit
(( ${+_comps} )) && _comps[zinit]=_zinit

# Load a few important annexes, without Turbo
# (this is currently required for annexes)
#zinit light-mode for \
#    zinit-zsh/z-a-patch-dl \
#    zinit-zsh/z-a-as-monitor

zi light-mode for zdharma-continuum/zinit-annex-bin-gem-node

zi light-mode lucid depth=1 for romkatv/powerlevel10k

zi pack for ls_colors

zi for \
    atclone'cp -vf completions/exa.zsh _exa'  \
    from'gh-r' \
    sbin'**/exa -> exa' \
  ogham/exa

# bunch'o exa aliases
 zi for TwoPizza9621536/zsh-exa

zi for \
    from'gh-r' \
    sbin'**/bat -> bat' \
  @sharkdp/bat

zi for \
    from'gh-r'  \
    sbin'**/fd -> fd' \
  @sharkdp/fd

zi for \
    from'gh-r'  \
    sbin'fzf'   \
  junegunn/fzf \
  https://github.com/junegunn/fzf/raw/master/shell/{'completion','key-bindings'}.zsh
# Below has conflicts on keybinds and doesn't work reliably.
# Keeping above bindings because they're handy.
#zi for joshskidmore/zsh-fzf-history-search

zi for \
    from'gh-r' \
    sbin'**/nvim -> nvim' \
  neovim/neovim

zi for \
    from'gh-r' \
    as'completions' \
    atclone'procs --completion zsh' \
    atpull'%atclone' \
    sbin'**/procs -> procs' \
  dalance/procs

zi for \
    from'gh-r' \
    sbin'g*x -> grex' \
  pemistahl/grex

zi for \
    from'gh-r' \
    as'completion' \
    atclone'cp hub**/etc/hub.zsh_completion _hub' \
    atpull'%atclone' \
    sbin'hub**/bin/hub -> hub' \
  @github/hub

zi for \
    as'completion' \
    nocompile \
    id-as'docker-completion/_docker' \
    is-snippet \
  https://raw.githubusercontent.com/docker/cli/master/contrib/completion/zsh/_docker

zi for \
    as"completion" \
    nocompile \
    id-as'asdf-completion/_asdf' \
    is-snippet \
  https://raw.githubusercontent.com/asdf-vm/asdf/master/completions/_asdf

zi for \
  mollifier/cd-gitroot

zi for \
  zdharma-continuum/fast-syntax-highlighting
if [ $(fast-theme -s | awk '/active/ {print $4}') != base16 ]; then
  fast-theme base16 &> /dev/null
fi

# Poetry auto-pyenv activation
#zi for darvid/zsh-poetry

# jq interactive query builder -- doesn't bind right in iterm2, haven't bothered to fix
#zi for reegnz/jq-zsh-plugin

# krew: https://github.com/zdharma-continuum/zinit/blob/main/tests/gh-r.zunit#L417
# bitwarden: https://github.com/kalsowerus/zsh-bitwarden

#zi for \
#    as'completion' \
#    nocompile \
#    id-as'keybase-completion/_keybase' \
#    is-snippet \
#  https://raw.githubusercontent.com/rbirnie/oh-my-zsh-keybase/master/keybase/_keybase

zi light-mode wait lucid depth=1 for \
  atload'bindkey -M vicmd "k" history-substring-search-up; bindkey -M vicmd "j" history-substring-search-down' \
    zsh-users/zsh-history-substring-search \
  blockf multisrc'*.plugin.zsh' pick'/dev/null' \
    ~/.zshrc.d \
  blockf multisrc'*.plugin.zsh' pick'/dev/null' \
    ~/.zshrc-private.d

# Bunch'o'completions
# Recommended to be loaded last.
zi wait lucid atload"zicompinit; zicdreplay" blockf for \
      zsh-users/zsh-completions

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh
(( ! ${+functions[p10k]} )) || p10k finalize
